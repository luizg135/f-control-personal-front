<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONTROLE FINANCEIRO</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-text: #e0e0e0;
            --secondary-text: #a0a0a0;
            --border-color: #333333;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --accent-blue: #007bff;
            --accent-blue-transparent: rgba(0, 123, 255, 0.2);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            margin: auto;
            padding: 24px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
            text-align: center;
        }

        header > div {
            flex-grow: 1;
            text-align: center;
        }

        header h1 {
            font-size: 36px;
            margin-bottom: 5px;
        }
        
        header p {
            font-size: 18px;
            color: var(--secondary-text);
            margin-top: 0;
        }

        .month-filter select {
            background-color: var(--surface-color);
            color: var(--primary-text);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background-color: var(--surface-color);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }
        .tab-button {
            flex-grow: 1;
            padding: 14px 20px;
            cursor: pointer;
            background-color: transparent;
            border: none;
            color: var(--secondary-text);
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .tab-button:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        .tab-button.active {
            color: var(--accent-blue);
            font-weight: 600;
            background-color: rgba(0, 123, 255, 0.1);
        }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        .card {
            background-color: var(--surface-color); padding: 20px; border-radius: 12px;
            border: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 8px;
        }
        .card-header {
            display: flex; align-items: center; gap: 12px;
            color: var(--secondary-text); font-weight: 500;
        }
        .card-header .material-symbols-outlined { font-size: 24px; }
        .card-content .value { font-size: 28px; font-weight: 700; letter-spacing: -1px; }
        .value.positive { color: var(--accent-green); }
        .value.negative { color: var(--accent-red); }
        .value.neutral { color: var(--accent-blue); }

        .charts-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px;
        }
        .chart-wrapper {
            background-color: var(--surface-color); padding: 20px; border-radius: 12px;
            border: 1px solid var(--border-color); display: flex; flex-direction: column; height: 400px;
        }
        .chart-wrapper h2 {
            margin-top: 0; margin-bottom: 20px; color: var(--secondary-text);
            font-weight: 500; font-size: 16px;
        }
        
        .table-wrapper { overflow-x: auto; }
        .transactions-table {
            width: 100%; border-collapse: collapse; background-color: var(--surface-color);
            border-radius: 12px; overflow: hidden;
        }
        .transactions-table th, .transactions-table td {
            padding: 16px; text-align: left; border-bottom: 1px solid var(--border-color);
        }
        .transactions-table th { font-weight: 600; font-size: 14px; color: var(--secondary-text); }
        .transactions-table tbody tr:last-child td { border-bottom: none; }
        .transactions-table tbody tr:hover { background-color: #2a2a2a; }
        .transactions-table .type-indicator { display: flex; align-items: center; gap: 8px; }
        .transactions-table .type-indicator .material-symbols-outlined { font-size: 20px; }
        
        .loading-message, .error-message {
            text-align: center; font-size: 18px; padding: 40px; color: var(--secondary-text);
        }

        @media (max-width: 1200px) { .charts-grid { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }
        @media (max-width: 600px) {
            .container { padding: 16px; }
            header { flex-direction: column; align-items: center; }
            header h1 { font-size: 22px; }
            header p { font-size: 16px; }
            .summary-grid { grid-template-columns: 1fr 1fr; }
            .card-content .value { font-size: 22px; }
            .tab-button { padding: 10px 12px; font-size: 14px; }
        }
    </style>
</head>
<body>

    <main class="container">
        <header>
            <div>
                <h1>CONTROLE FINANCEIRO</h1>
                <p>Olá, Luiz! Aqui estão suas finanças.</p>
            </div>
            <div class="month-filter">
                <select id="monthSelector"></select>
            </div>
        </header>

        <nav class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'resumo')">Resumo</button>
            <button class="tab-button" onclick="openTab(event, 'graficos')">Gráficos</button>
            <button class="tab-button" onclick="openTab(event, 'relatorio')">Relatório</button>
        </nav>

        <div id="loading" class="loading-message"><p>Carregando dados... ⚡️</p></div>
        <div id="error" class="error-message" style="display: none;"><p>Não foi possível carregar os dados.</p></div>

        <div id="resumo" class="tab-content active">
            <section class="summary-grid"> </section>
        </div>

        <div id="graficos" class="tab-content">
            <section class="charts-grid">
                <div class="chart-wrapper" id="monthlyBalanceChartContainer"><h2>Balanço Mensal</h2><canvas id="monthlyBalanceChart"></canvas></div>
                <div class="chart-wrapper"><h2>Despesas por Categoria</h2><canvas id="expensesByCategoryChart"></canvas></div>
                <div class="chart-wrapper"><h2>Despesas por Grupo</h2><canvas id="expensesByGroupChart"></canvas></div>
            </section>
        </div>

        <div id="relatorio" class="tab-content">
            <section class="table-wrapper">
                <table class="transactions-table">
                    <thead>
                        <tr><th>Tipo</th><th>Item</th><th>Categoria</th><th>Data</th><th>Valor</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>
        </div>
    </main>

    <script>
        // ‼️‼️‼️ ALTERE A LINHA ABAIXO COM A URL DA SUA API NO RENDER ‼️‼️‼️
        const apiUrl = 'https://f-control-personal.onrender.com/api/financial/data';

        let fullData = {};
        let selectedMonth = 'all';
        let charts = {};

        const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatDate = (isoString) => new Date(isoString).toLocaleDateString('pt-BR', { timeZone: 'UTC' });

        function openTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            Chart.defaults.color = 'rgba(224, 224, 224, 0.8)';
            Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                fullData = await response.json();
                loadingDiv.style.display = 'none';
                populateMonthFilter();
                updateDashboard();
            } catch (err) {
                console.error('Erro ao buscar dados:', err);
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
            }
        });

        function populateMonthFilter() {
            const selector = document.getElementById('monthSelector');
            selector.innerHTML = `<option value="all">Todos os Meses</option>`;
            fullData.meses_disponiveis.forEach(month => {
                selector.innerHTML += `<option value="${month}">${month}</option>`;
            });
            selector.addEventListener('change', (event) => {
                selectedMonth = event.target.value;
                updateDashboard();
            });
        }

        function updateDashboard() {
            let filteredTransactions = (selectedMonth === 'all')
                ? fullData.transacoes
                : fullData.transacoes.filter(t => t.MesAno === selectedMonth);

            const summary = calculateSummary(filteredTransactions);
            const despesas = filteredTransactions.filter(t => t.Tipo === 'Despesa');
            const expensesByCategory = aggregateBy(despesas, 'Categoria');
            const expensesByGroup = aggregateBy(despesas, 'Grupo');

            renderSummaryCards(summary);
            renderCharts(fullData.saldo_mensal, expensesByCategory, expensesByGroup);
            renderTransactionsTable(filteredTransactions);
        }
        
        function calculateSummary(transactions) {
            const summary = { total_entradas: 0, total_saidas: 0, saldo: 0, valor_conta: 0, valor_alimentacao: 0, valor_reserva: 0 };
            transactions.forEach(t => {
                const valor = t.Valor || 0;
                if (t.Tipo === 'Receita') {
                    summary.total_entradas += valor;
                    if (!t.Categoria.includes('Reserva')) summary.valor_conta += valor;
                    if (t.Conta && t.Conta.includes('Alimentação')) summary.valor_alimentacao += valor;
                    if (t.Categoria.includes('Reserva')) summary.valor_reserva += valor;
                } else if (t.Tipo === 'Despesa') {
                    summary.total_saidas += valor;
                    if (!t.Categoria.includes('Reserva')) summary.valor_conta -= valor;
                    if (t.Conta && t.Conta.includes('Alimentação')) summary.valor_alimentacao -= valor;
                    if (t.Categoria.includes('Reserva')) summary.valor_reserva -= valor;
                }
            });
            summary.saldo = summary.total_entradas - summary.total_saidas;
            return summary;
        }

        function aggregateBy(transactions, key) {
            return transactions.reduce((acc, t) => {
                const groupKey = t.Grupo || 'Outros'; // Default para 'Outros' se o grupo não estiver definido
                acc[`${t.Grupo}`] = (acc[`${t.Grupo}`] || 0) + (t.Valor || 0);
                return acc;
            }, {});
        }

        function renderSummaryCards(summary) {
            const container = document.querySelector('#resumo .summary-grid');
            const cardsData = [
                { title: 'Saldo em Conta', value: summary.valor_conta, icon: 'account_balance_wallet', type: 'neutral' },
                { title: 'Cartão Alimentação', value: summary.valor_alimentacao, icon: 'restaurant', type: 'neutral' },
                { title: 'Reserva', value: summary.valor_reserva, icon: 'savings', type: 'positive' },
                { title: 'Saldo do Período', value: summary.saldo, icon: 'account_balance', type: summary.saldo >= 0 ? 'positive' : 'negative' },
                { title: 'Entradas do Período', value: summary.total_entradas, icon: 'arrow_upward', type: 'positive' },
                { title: 'Saídas do Período', value: summary.total_saidas, icon: 'arrow_downward', type: 'negative' }
            ];
            container.innerHTML = cardsData.map(card => `
                <article class="card">
                    <div class="card-header"><span class="material-symbols-outlined">${card.icon}</span><span>${card.title}</span></div>
                    <div class="card-content"><p class="value ${card.type}">${formatCurrency(card.value)}</p></div>
                </article>
            `).join('');
        }
        
        function destroyCharts() {
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
        }

        function renderCharts(monthlyBalanceData, categoryData, groupData) {
            destroyCharts();
            
            const monthlyBalanceContainer = document.getElementById('monthlyBalanceChartContainer');
            monthlyBalanceContainer.style.display = selectedMonth === 'all' ? 'flex' : 'none';

            if (selectedMonth === 'all') {
                const sortedMonths = Object.keys(monthlyBalanceData).sort();
                charts.monthly = new Chart(document.getElementById('monthlyBalanceChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: sortedMonths,
                        datasets: [{
                            label: 'Saldo Mensal', data: sortedMonths.map(m => monthlyBalanceData && monthlyBalanceData.hasOwnProperty(m) ? monthlyBalanceData[(m)] : 0),
                            fill: true, borderColor: 'var(--accent-blue)', backgroundColor: 'rgba(0, 123, 255, 0.2)', tension: 0.3
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
		scales: {
		y: {
		suggestedMin: 0 // <-- AQUI ESTÁ A CORREÇÃO
		}
		}
		}
		});
		}

            charts.category = new Chart(document.getElementById('expensesByCategoryChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{
                        data: Object.values(categoryData),
                        backgroundColor: ['#177E89', '#4A86B3', '#77A1D3', '#A7BEE3', '#D7DFF2', '#E0F2F7'],
                        borderColor: 'var(--surface-color)', borderWidth: 2
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12 } } } }
            });

            charts.group = new Chart(document.getElementById('expensesByGroupChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: Object.keys(groupData),
                    datasets: [{
                        label: 'Despesas por Grupo', data: Object.values(groupData),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }
        
        function renderTransactionsTable(transactions) {
            const tbody = document.querySelector('.transactions-table tbody');
            if (transactions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Nenhum lançamento para o período.</td></tr>`;
                return;
            }
            tbody.innerHTML = transactions.sort((a, b) => new Date(b.Data) - new Date(a.Data)).map(t => `
                <tr>
                    <td><div class="type-indicator" style="color:${t.Tipo === 'Receita' ? 'var(--accent-green)' : 'var(--accent-red)'};"><span class="material-symbols-outlined">${t.Tipo === 'Receita' ? 'arrow_upward' : 'arrow_downward'}</span>${t.Tipo}</div></td>
                    <td>${t.Item || 'N/A'}</td>
                    <td>${t.Categoria || 'N/A'}</td>
                    <td>${formatDate(t.Data)}</td>
                    <td style="font-weight:600; color:${t.Tipo === 'Receita' ? 'var(--accent-green)' : 'var(--primary-text)'};">${formatCurrency(t.Valor || 0)}</td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>