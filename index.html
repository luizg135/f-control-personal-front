<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONTROLE FINANCEIRO</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-text: #e0e0e0;
            --secondary-text: #a0a0a0;
            --border-color: #333333;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --accent-blue: #007bff;
            --accent-blue-transparent: rgba(0, 123, 255, 0.2);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1400px;
            margin: auto;
            padding: 24px;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        .header-title {
            flex-grow: 1;
            text-align: center;
        }
        header h1 {
            font-size: 32px;
            margin: 0;
            font-weight: 700;
        }
        header p {
            font-size: 16px;
            color: var(--secondary-text);
            margin-top: 4px;
        }
        .month-filter select {
            background-color: var(--surface-color);
            color: var(--primary-text);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
        }
        .tabs {
            display: flex;
            background-color: var(--surface-color);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }
        .tab-button {
            flex-grow: 1;
            padding: 14px 20px;
            cursor: pointer;
            background-color: transparent;
            border: none;
            color: var(--secondary-text);
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            border-bottom: 3px solid transparent;
        }
        .tab-button:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        .tab-button.active {
            color: var(--primary-text);
            font-weight: 600;
            border-bottom: 3px solid var(--accent-blue);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        .card {
            background-color: var(--surface-color); padding: 20px; border-radius: 12px;
            border: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 8px;
        }
        .card-header {
            display: flex; align-items: center; gap: 12px;
            color: var(--secondary-text); font-weight: 500;
        }
        .card-header .material-symbols-outlined { font-size: 24px; }
        .card-content .value { font-size: 28px; font-weight: 700; letter-spacing: -1px; }
        .value.positive { color: var(--accent-green); }
        .value.negative { color: var(--accent-red); }
        .value.neutral { color: var(--accent-blue); }

        .charts-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; }
        .chart-wrapper {
            background-color: var(--surface-color); padding: 20px; border-radius: 12px;
            border: 1px solid var(--border-color); display: flex; flex-direction: column; height: 400px;
        }
        .chart-wrapper h2 {
            margin-top: 0; margin-bottom: 20px; color: var(--secondary-text);
            font-weight: 500; font-size: 16px;
        }
        
        .table-wrapper { overflow-x: auto; }
        .transactions-table {
            width: 100%; border-collapse: collapse; background-color: var(--surface-color);
            border-radius: 12px; overflow: hidden;
        }
        .transactions-table th, .transactions-table td {
            padding: 16px; text-align: left; border-bottom: 1px solid var(--border-color);
        }
        .transactions-table th { font-weight: 600; font-size: 14px; color: var(--secondary-text); }
        .transactions-table tbody tr:last-child td { border-bottom: none; }
        .transactions-table tbody tr:hover { background-color: #2a2a2a; }
        .transactions-table .type-indicator { display: flex; align-items: center; gap: 8px; }
        .transactions-table .type-indicator .material-symbols-outlined { font-size: 20px; }
        
        .loading-message, .error-message {
            text-align: center; font-size: 18px; padding: 40px; color: var(--secondary-text);
        }

        @media (max-width: 1200px) { .charts-grid { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }
        @media (max-width: 700px) {
            .container { padding: 16px; }
            header { flex-direction: column; align-items: center; }
            header h1 { font-size: 24px; }
            header p { font-size: 14px; }
            .summary-grid { grid-template-columns: 1fr 1fr; }
            .card-content .value { font-size: 22px; }
            .tab-button { padding: 10px 12px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <main class="container">
        <header>
            <div class="header-title">
                <h1>CONTROLE FINANCEIRO</h1>
                <p>Olá, Luiz! Aqui estão suas finanças.</p>
            </div>
            <div class="month-filter">
                <select id="monthSelector"></select>
            </div>
        </header>

        <nav class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'resumo')">Resumo</button>
            <button class="tab-button" onclick="openTab(event, 'graficos')">Gráficos</button>
            <button class="tab-button" onclick="openTab(event, 'relatorio')">Relatório</button>
        </nav>

        <div id="loading" class="loading-message"><p>Carregando dados... ⚡️</p></div>
        <div id="error" class="error-message" style="display: none;"><p>Não foi possível carregar os dados.</p></div>

        <div id="resumo" class="tab-content active"><section class="summary-grid"></section></div>
        <div id="graficos" class="tab-content">
            <section class="charts-grid">
                <div class="chart-wrapper" id="monthlyBalanceChartContainer"><h2>Balanço Mensal</h2><canvas id="monthlyBalanceChart"></canvas></div>
                <div class="chart-wrapper"><h2>Despesas por Categoria</h2><canvas id="expensesByCategoryChart"></canvas></div>
                <div class="chart-wrapper"><h2>Despesas por Grupo</h2><canvas id="expensesByGroupChart"></canvas></div>
            </section>
        </div>
        <div id="relatorio" class="tab-content">
            <section class="table-wrapper">
                <table class="transactions-table">
                    <thead><tr><th>Tipo</th><th>Item</th><th>Categoria</th><th>Data</th><th>Valor</th></tr></thead>
                    <tbody></tbody>
                </table>
            </section>
        </div>
    </main>

    <script>
        const apiUrl = 'https://f-control-personal.onrender.com/api/financial/data';
        let fullData = {}, selectedMonth = 'all', charts = {};

        const formatCurrency = (val) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatDate = (iso) => new Date(iso).toLocaleDateString('pt-BR', { timeZone: 'UTC' });

        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            Chart.register(ChartDataLabels);
            Chart.defaults.color = 'rgba(224, 224, 224, 0.8)';
            Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
            Chart.defaults.plugins.datalabels.color = '#fff';
            Chart.defaults.plugins.datalabels.font = { weight: 'bold' };
            
            try {
                document.getElementById('loading').style.display = 'block';
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                fullData = await response.json();
                document.getElementById('loading').style.display = 'none';
                populateMonthFilter();
                updateDashboard();
            } catch (err) {
                console.error('Erro ao buscar dados:', err);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        });

        function populateMonthFilter() {
            const selector = document.getElementById('monthSelector');
            selector.innerHTML = `<option value="all">Todos os Meses</option>`;
            fullData.meses_disponiveis.forEach(m => selector.innerHTML += `<option value="${m}">${m}</option>`);
            selector.addEventListener('change', (e) => {
                selectedMonth = e.target.value;
                updateDashboard();
            });
        }

        function updateDashboard() {
            const filtered = (selectedMonth === 'all') ? fullData.transacoes : fullData.transacoes.filter(t => t.MesAno === selectedMonth);
            const summary = calculateSummary(filtered);
            const expenses = filtered.filter(t => t.Tipo === 'Despesa');
            const byCategory = aggregateBy(expenses, 'Categoria');
            const byGroup = aggregateBy(expenses, 'Grupo');
            renderSummaryCards(summary);
            renderCharts(fullData.saldo_mensal, byCategory, byGroup);
            renderTransactionsTable(filtered);
        }

        function calculateSummary(transactions) {
            const s = { total_entradas: 0, total_saidas: 0, saldo: 0, valor_conta: 0, valor_alimentacao: 0, valor_reserva: 0 };
            transactions.forEach(t => {
                const v = t.Valor || 0;
                if (t.Tipo === 'Receita') {
                    s.total_entradas += v;
                    if (!t.Categoria.includes('Reserva')) s.valor_conta += v;
                    if (t.Conta && t.Conta.includes('Alimentação')) s.valor_alimentacao += v;
                    if (t.Categoria.includes('Reserva')) s.valor_reserva += v;
                } else if (t.Tipo === 'Despesa') {
                    s.total_saidas += v;
                    if (!t.Categoria.includes('Reserva')) s.valor_conta -= v;
                    if (t.Conta && t.Conta.includes('Alimentação')) s.valor_alimentacao -= v;
                    if (t.Categoria.includes('Reserva')) s.valor_reserva -= v;
                }
            });
            s.saldo = s.total_entradas - s.total_saidas;
            return s;
        }

        const aggregateBy = (trans, key) => trans.reduce((acc, t) => {
            const groupKey = t[key] || 'N/A';
            acc[groupKey] = (acc[groupKey] || 0) + (t.Valor || 0);
            return acc;
        }, {});

        function renderSummaryCards(summary) {
            const container = document.querySelector('#resumo .summary-grid');
            const cards = [
                { t: 'Saldo em Conta', v: summary.valor_conta, i: 'account_balance_wallet', c: 'neutral' },
                { t: 'Cartão Alimentação', v: summary.valor_alimentacao, i: 'restaurant', c: 'neutral' },
                { t: 'Reserva', v: summary.valor_reserva, i: 'savings', c: 'positive' },
                { t: 'Saldo do Período', v: summary.saldo, i: 'account_balance', c: summary.saldo >= 0 ? 'positive' : 'negative' },
                { t: 'Entradas do Período', v: summary.total_entradas, i: 'arrow_upward', c: 'positive' },
                { t: 'Saídas do Período', v: summary.total_saidas, i: 'arrow_downward', c: 'negative' }
            ];
            container.innerHTML = cards.map(c => `<article class="card"><div class="card-header"><span class="material-symbols-outlined">${c.i}</span><span>${c.t}</span></div><div class="card-content"><p class="value ${c.c}">${formatCurrency(c.v)}</p></div></article>`).join('');
        }

        function destroyCharts() { Object.values(charts).forEach(c => c && c.destroy()); charts = {}; }

        function renderCharts(monthlyData, categoryData, groupData) {
            destroyCharts();
            document.getElementById('monthlyBalanceChartContainer').style.display = selectedMonth === 'all' ? 'flex' : 'none';

            if (selectedMonth === 'all') {
                const sortedMonths = Object.keys(monthlyData).sort();
                charts.monthly = new Chart(document.getElementById('monthlyBalanceChart'), {
                    type: 'line',
                    data: {
                        labels: sortedMonths,
                        datasets: [{ data: sortedMonths.map(m => monthlyData[m]), fill: true, borderColor: 'var(--accent-blue)', backgroundColor: 'var(--accent-blue-transparent)', tension: 0.3 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: false } }, scales: { y: { suggestedMin: 0 } } }
                });
            }

            charts.category = new Chart(document.getElementById('expensesByCategoryChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{ data: Object.values(categoryData), backgroundColor: ['#177E89', '#4A86B3', '#77A1D3', '#A7BEE3', '#D7DFF2'], borderColor: 'var(--surface-color)', borderWidth: 2 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12 } }, datalabels: {
                    formatter: (val, ctx) => { const s = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); return s === 0 ? '0%' : (val * 100 / s).toFixed(0) + "%"; }
                }}}
            });

            charts.group = new Chart(document.getElementById('expensesByGroupChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(groupData),
                    datasets: [{ label: 'Despesas', data: Object.values(groupData), backgroundColor: 'rgba(54, 162, 235, 0.7)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: false } } }
            });
        }

        function renderTransactionsTable(transactions) {
            const tbody = document.querySelector('.transactions-table tbody');
            if (!transactions.length) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Nenhum lançamento para o período.</td></tr>`;
                return;
            }
            tbody.innerHTML = transactions.sort((a,b) => new Date(b.Data) - new Date(a.Data))
                .map(t => `<tr><td><div class="type-indicator" style="color:${t.Tipo==='Receita'?'var(--accent-green)':'var(--accent-red)'};"><span class="material-symbols-outlined">${t.Tipo==='Receita'?'arrow_upward':'arrow_downward'}</span>${t.Tipo}</div></td><td>${t.Item||'N/A'}</td><td>${t.Categoria||'N/A'}</td><td>${formatDate(t.Data)}</td><td style="font-weight:600;color:${t.Tipo==='Receita'?'var(--accent-green)':'var(--primary-text)'};">${formatCurrency(t.Valor||0)}</td></tr>`)
                .join('');
        }
    </script>
</body>
</html>